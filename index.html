<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arttes da Bel - Ferramentas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#F3E4D7',
                        'brand-text': '#786D4E',
                        'brand-olive': '#A5A184',
                        'brand-pink': '#F39B92',
                        'brand-primary': '#DA7E55',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Montserrat', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-family: 'Inter', sans-serif; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #DA7E55; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .input-prefix { position: absolute; left: 0; top: 0; height: 100%; display: flex; align-items: center; padding-left: 0.75rem; color: #6b7280; }
        .input-group input { padding-left: 2.5rem; }
        .saved-status { transition: opacity 0.5s ease-in-out, color 0.3s; }
        #sidebar { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-brand-bg/50 text-brand-text">

    <!-- Seção de Autenticação -->
    <div id="authContainer">
        <!-- Tela de Login -->
        <div id="loginView">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-md">
                    <header class="text-center mb-8">
                        <img src="/assets/logo.png" alt="Logo Arttes da Bel" class="mx-auto w-48 h-auto mb-4">
                        <h1 class="font-display text-3xl text-brand-primary">Área Exclusiva</h1>
                        <p class="text-brand-text">Acesse a calculadora e outras ferramentas.</p>
                    </header>
                    <main class="bg-white p-8 rounded-2xl shadow-lg shadow-brand-olive/20">
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label for="loginEmail" class="block text-sm font-medium text-brand-text">Email</label>
                                <input type="email" id="loginEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                            <div>
                                <label for="loginPassword" class="block text-sm font-medium text-brand-text">Senha</label>
                                <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                            <div id="loginErrorMessage" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-white bg-brand-primary hover:bg-brand-text focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary font-semibold">Entrar</button>
                        </form>
                        <p class="text-center text-sm mt-6">
                            Não tem uma conta? <a href="#" id="showRegisterViewLink" class="font-medium text-brand-primary hover:underline">Cadastre-se</a>
                        </p>
                    </main>
                    <footer class="text-center mt-8 text-sm text-gray-500">
                        <p>&copy; 2024 - Arttes da Bel</p>
                    </footer>
                </div>
            </div>
        </div>
        <!-- Tela de Cadastro -->
        <div id="registerView" class="hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-md">
                    <header class="text-center mb-8">
                        <img src="/assets/logo.png" alt="Logo Arttes da Bel" class="mx-auto w-48 h-auto mb-4">
                        <h1 class="font-display text-3xl text-brand-primary">Crie sua Conta</h1>
                        <p class="text-brand-text">É rápido e fácil!</p>
                    </header>
                    <main class="bg-white p-8 rounded-2xl shadow-lg shadow-brand-olive/20">
                        <form id="registerForm" class="space-y-6">
                            <div>
                                <label for="registerName" class="block text-sm font-medium text-brand-text">Seu Nome</label>
                                <input type="text" id="registerName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                            <div>
                                <label for="registerEmail" class="block text-sm font-medium text-brand-text">Email</label>
                                <input type="email" id="registerEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                            <div>
                                <label for="registerPassword" class="block text-sm font-medium text-brand-text">Senha</label>
                                <input type="password" id="registerPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                            <div id="registerErrorMessage" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-white bg-brand-primary hover:bg-brand-text focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary font-semibold">Criar Conta</button>
                        </form>
                         <p class="text-center text-sm mt-6">
                            Já tem uma conta? <a href="#" id="showLoginViewLink" class="font-medium text-brand-primary hover:underline">Faça o login</a>
                        </p>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção do Aplicativo (Layout Principal) -->
    <div id="appView" class="hidden">
        <div class="relative min-h-screen md:flex">
            <!-- Overlay para fechar sidebar no mobile -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            
            <!-- Barra Lateral Retrátil -->
            <aside id="sidebar" class="bg-brand-bg text-brand-text w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30">
                <a href="#dashboard" class="nav-link text-white text-xl flex items-center px-4">
                    <img src="/assets/logo.png" alt="Logo Arttes da Bel" class="w-32 h-auto mx-auto">
                </a>
                <nav>
                    <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white bg-brand-primary/20">Página Inicial</a>
                    <a href="#calculator" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Calculadora de Preço</a>
                    <a href="#my-pieces" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Minhas Peças Salvas</a>
                    <a href="#management" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white opacity-50 cursor-not-allowed">Gestão de Encomendas</a>
                    <a href="#stock" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white opacity-50 cursor-not-allowed">Controle de Estoque</a>
                    <a href="#settings" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Configurações</a>
                </nav>
            </aside>
            
            <!-- Conteúdo Principal -->
            <div class="flex-1 flex flex-col">
                <header class="flex justify-between items-center p-4 bg-white shadow-md">
                    <button id="sidebar-toggle" class="text-brand-text focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex items-center gap-4">
                        <a href="#settings" class="nav-link text-brand-text hover:text-brand-primary">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </a>
                        <button id="logoutButton" class="text-sm bg-brand-pink text-white font-semibold py-1 px-3 rounded-full hover:bg-brand-primary transition-colors">Sair</button>
                    </div>
                </header>
                
                <div id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <!-- Páginas do App serão inseridas aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Templates das Páginas do App -->
    <template id="dashboard-template">
        <div id="dashboardView">
            <h1 class="font-display text-3xl text-brand-text mb-2">Bem-vinda, Artesã!</h1>
            <p id="welcomeMessage" class="text-lg text-gray-600 mb-8">Aqui você encontra as ferramentas para florescer seu ateliê.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <a href="#calculator" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 hover:shadow-xl transition-shadow">
                    <h2 class="font-display text-xl text-brand-primary">Calculadora de Preço</h2>
                    <p class="mt-2 text-sm">Calcule o preço justo de suas peças com confiança e garanta seu lucro.</p>
                </a>
                <a href="#my-pieces" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 hover:shadow-xl transition-shadow">
                    <h2 class="font-display text-xl text-brand-primary">Minhas Peças Salvas</h2>
                    <p class="mt-2 text-sm">Acesse seu catálogo de produtos com preços já calculados.</p>
                </a>
                <a href="#management" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 opacity-50 cursor-not-allowed">
                    <h2 class="font-display text-xl text-brand-text">Gestão de Encomendas</h2>
                    <p class="mt-2 text-sm">Organize seus pedidos e acompanhe o status de cada um. (Em breve)</p>
                </a>
                <a href="#stock" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 opacity-50 cursor-not-allowed">
                    <h2 class="font-display text-xl text-brand-text">Controle de Estoque</h2>
                    <p class="mt-2 text-sm">Saiba exatamente quais materiais você tem e quando precisa comprar mais. (Em breve)</p>
                </a>
            </div>
        </div>
    </template>

    <template id="calculator-template">
        <div id="calculatorView">
            <main class="space-y-8">
                <div id="restoreBanner" class="hidden bg-brand-olive/20 p-4 rounded-lg flex items-center justify-between">
                    <p class="text-brand-text font-medium">Encontramos um cálculo não salvo. Deseja restaurá-lo?</p>
                    <div>
                        <button id="restoreYes" class="bg-brand-primary text-white px-3 py-1 rounded-md text-sm font-semibold mr-2">Sim</button>
                        <button id="restoreNo" class="bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm">Não</button>
                    </div>
                </div>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                        <span class="text-3xl mr-3">1.</span> Custos da Peça
                    </h2>
                    <div>
                        <label for="pieceName" class="block text-sm font-medium text-brand-text">Nome da Peça</label>
                        <p class="text-xs text-gray-500 mt-1">Dê um nome para este cálculo (Ex: Jogo Americano Floral).</p>
                        <input type="text" id="pieceName" class="piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="Jogo Americano Floral">
                    </div>
                    <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">A. Custo dos Materiais</h3>
                    <div id="materialsContainer" class="space-y-4"></div>
                    <button id="addMaterial" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Material</button>
                    <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                        <span class="font-medium text-gray-600">Subtotal de Materiais:</span>
                        <span id="materialsSubtotal" class="font-bold text-gray-800 ml-2">R$ 0,00</span>
                    </div>
                    <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">B. Custo da Mão de Obra</h3>
                    <div id="tasksContainer" class="space-y-4"></div>
                    <button id="addTask" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Tarefa</button>
                    <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                        <span class="font-medium text-gray-600">Tempo Total de Produção:</span>
                        <span id="totalTime" class="font-bold text-gray-800 ml-2">0 min</span>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                       <span class="text-3xl mr-3">2.</span> Resumo dos Custos
                    </h2>
                     <div class="mt-4 bg-brand-bg p-3 rounded-lg text-center mb-4">
                        <p class="text-sm text-brand-text">Custo Fixo por Hora do Ateliê (configurado por você):</p>
                        <p id="fixedCostPerHour" class="text-lg font-bold text-brand-text">R$ 0,00</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Total de Materiais</span>
                            <span id="summaryMaterials" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Total da Mão de Obra</span>
                            <span id="summaryLabor" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Fixo da Peça</span>
                            <span id="summaryFixed" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-brand-olive/20 p-4 rounded-lg mt-2">
                            <span class="font-bold text-brand-text text-lg">CUSTO DE PRODUÇÃO DA PEÇA</span>
                            <span id="productionCost" class="font-extrabold text-2xl text-brand-text">R$ 0,00</span>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                        <span class="text-3xl mr-3">3.</span> Preço Final de Venda
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                        <div>
                            <label for="profitMargin" class="block text-sm font-medium text-brand-text">Sua Margem de Lucro (%)</label>
                            <p class="text-xs text-gray-500 mt-1">Quanto você quer lucrar sobre o custo. 100% é um bom começo.</p>
                            <input type="text" inputmode="decimal" id="profitMargin" class="numeric-input piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" value="100">
                        </div>
                        <div>
                            <label for="fees" class="block text-sm font-medium text-brand-text">Taxas (%)</label>
                            <p class="text-xs text-gray-500 mt-1">Taxas de cartão, marketplace, etc.</p>
                            <input type="text" inputmode="decimal" id="fees" class="numeric-input piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" value="5">
                        </div>
                    </div>
                    <div class="mt-6 space-y-4">
                        <div class="bg-brand-primary text-white p-6 rounded-2xl text-center">
                            <p class="font-semibold text-lg opacity-90">PREÇO DE VENDA FINAL (SUGERIDO)</p>
                            <p id="finalPrice" class="font-extrabold text-5xl tracking-tight">R$ 0,00</p>
                        </div>
                        <div class="bg-brand-pink/30 border-l-4 border-brand-pink text-brand-text p-4 rounded-r-lg">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-lg">LUCRO LÍQUIDO POR PEÇA:</p>
                                <p id="netProfit" class="font-bold text-2xl">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                </section>
                <div class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <button id="savePieceButton" class="w-full bg-brand-olive text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center text-lg">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Salvar Peça no Catálogo
                    </button>
                </div>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                       <span class="text-3xl mr-3">4.</span> Assistente de Vendas IA ✨
                    </h2>
                    <p class="text-gray-600 mb-6">Use a inteligência artificial para criar textos de venda e ter ideias para divulgar seu produto. Preencha os dados da peça acima e clique nos botões abaixo.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-display text-lg font-semibold text-brand-text">Descrição Mágica para Redes Sociais</h3>
                            <button id="generateDescription" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                Gerar Descrição
                            </button>
                            <div id="descriptionLoader" class="loader hidden"></div>
                            <div id="descriptionResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border">
                                ✨ Clique em 'Gerar Descrição' e veja a mágica acontecer! Criaremos um texto de venda encantador para sua peça.
                            </div>
                        </div>
                        <div>
                            <h3 class="font-display text-lg font-semibold text-brand-text">Ideias Criativas para Vender Mais</h3>
                            <button id="generateSuggestions" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.95 16.464l.707-.707a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414zm-3.536-2.121a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>
                                Gerar Ideias
                            </button>
                            <div id="suggestionsLoader" class="loader hidden"></div>
                            <div id="suggestionsResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border">
                                💡 Sem inspiração? Clique em 'Gerar Ideias' para descobrir novas formas de divulgar e vender seu produto!
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </template>
    
    <template id="my-pieces-template">
        <div id="myPiecesView">
            <h1 class="font-display text-3xl text-brand-text mb-8">Minhas Peças Salvas</h1>
            <div id="savedPiecesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards de peças salvas serão inseridos aqui -->
            </div>
            <div id="noPiecesMessage" class="hidden text-center mt-8">
                <p class="text-lg text-gray-600">Você ainda não salvou nenhuma peça.</p>
                <a href="#calculator" class="nav-link mt-4 inline-block bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors">Calcular minha primeira peça</a>
            </div>
        </div>
    </template>

    <template id="settings-template">
        <div id="settingsView">
            <h1 class="font-display text-3xl text-brand-text mb-8">Configurações</h1>
            <div class="space-y-8 max-w-2xl mx-auto">
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4">Meu Perfil</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="profileName" class="block text-sm font-medium text-brand-text">Seu Nome</label>
                            <input type="text" id="profileName" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="profileEmail" class="block text-sm font-medium text-brand-text">Email</label>
                            <input type="email" id="profileEmail" disabled class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
                        </div>
                        <button id="saveProfileButton" class="bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors">Salvar Perfil</button>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-display text-2xl text-brand-text">Dados do Ateliê</h2>
                        <span id="settingsStatus" class="saved-status text-sm font-medium text-brand-olive opacity-0 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>Salvo!</span>
                        </span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="settingsHourlyRate" class="block text-sm font-medium text-brand-text">Valor da sua Hora de Trabalho</label>
                            <div class="relative mt-1 input-group">
                                <span class="input-prefix">R$</span>
                                <input type="text" inputmode="decimal" id="settingsHourlyRate" class="settings-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="20,00">
                            </div>
                        </div>
                        <div>
                            <label for="settingsFixedCosts" class="block text-sm font-medium text-brand-text">Custos Fixos Mensais</label>
                            <div class="relative mt-1 input-group">
                                 <span class="input-prefix">R$</span>
                                <input type="text" inputmode="decimal" id="settingsFixedCosts" class="settings-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="300,00">
                            </div>
                        </div>
                        <div>
                            <label for="settingsHoursWorked" class="block text-sm font-medium text-brand-text">Horas Trabalhadas por Mês</label>
                            <input type="text" inputmode="decimal" id="settingsHoursWorked" class="settings-input numeric-input w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm" placeholder="80">
                        </div>
                    </div>
                     <button id="saveAtelierButton" class="mt-4 w-full bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors">Salvar Dados do Ateliê</button>
                </section>
            </div>
        </div>
    </template>
    
    <template id="coming-soon-template">
        <div class="text-center">
            <h1 class="font-display text-3xl text-brand-text mb-4">Em Breve</h1>
            <p class="text-lg text-gray-600">Esta funcionalidade está sendo preparada com muito carinho e estará disponível em breve!</p>
        </div>
    </template>

    <!-- Modal de Boas-vindas -->
    <div id="welcomeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full text-center shadow-xl">
            <h2 class="font-display text-2xl text-brand-primary mb-4">Seja bem-vinda, artesã!</h2>
            <p class="text-brand-text mb-6">Ficamos felizes em te ver por aqui! Para começar, o primeiro passo é configurar os dados base do seu ateliê na página de Configurações.</p>
            <button id="closeWelcomeModal" class="w-full bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors">Ir para Configurações</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        async function getFirebaseConfig() {
            try {
                const response = await fetch('/api/get-firebase-config');
                if (!response.ok) throw new Error('Falha ao buscar configuração do Firebase.');
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function main() {
            const authContainer = document.getElementById('authContainer');
            const appView = document.getElementById('appView');
            const errorMessageDiv = document.getElementById('loginErrorMessage');

            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) {
                errorMessageDiv.textContent = 'Erro de configuração. Não foi possível carregar a página.';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            let currentUser = null;
            let atelierDataRef = null;
            let piecesCollectionRef = null;
            let atelierData = {};

            // ===================================================================
            // INÍCIO DO CÓDIGO MODIFICADO PARA O LOGIN (SESSÃO)
            // ===================================================================
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Utilizador está autenticado. Agora, vamos verificar se o acesso dele ainda é válido.
                    const authorizedEmailRef = doc(db, "authorizedEmails", user.email);
                    getDoc(authorizedEmailRef).then(docSnap => {
                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            const expirationDate = userData.expirationDate.toDate();
                            const now = new Date();

                            if (now < expirationDate) {
                                // O acesso está válido, carrega o aplicativo normalmente
                                currentUser = user;
                                atelierDataRef = doc(db, "atelierData", user.uid);
                                piecesCollectionRef = collection(db, "atelierData", currentUser.uid, "pieces");
                                authContainer.classList.add('hidden');
                                appView.classList.remove('hidden');
                                loadUserDataAndNavigate();
                            } else {
                                // O acesso expirou! Desconecta o utilizador e mostra uma mensagem.
                                alert('Seu acesso expirou. Por favor, renove sua assinatura para continuar usando a ferramenta.');
                                signOut(auth); // Desconecta o utilizador
                            }
                        } else {
                            // Caso raro: utilizador registado mas não está na lista. Desconecta por segurança.
                            alert('Não foi possível verificar sua autorização de acesso. Por favor, entre em contato com o suporte.');
                            signOut(auth);
                        }
                    }).catch(error => {
                        console.error("Erro ao verificar acesso do utilizador:", error);
                        alert('Ocorreu um erro ao verificar seu status de acesso. Tente fazer login novamente.');
                        signOut(auth);
                    });
                } else {
                    // Utilizador não está autenticado, mostra a tela de login
                    currentUser = null;
                    authContainer.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });
            // ===================================================================
            // FIM DO CÓDIGO MODIFICADO
            // ===================================================================

            const loginView = document.getElementById('loginView');
            const registerView = document.getElementById('registerView');
            document.getElementById('showRegisterViewLink').addEventListener('click', (e) => {
                e.preventDefault();
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
            });

            document.getElementById('showLoginViewLink').addEventListener('click', (e) => {
                e.preventDefault();
                registerView.classList.add('hidden');
                loginView.classList.remove('hidden');
            });
            
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch((error) => {
                        document.getElementById('loginErrorMessage').textContent = 'Email ou senha inválidos.';
                        document.getElementById('loginErrorMessage').classList.remove('hidden');
                    });
            });

            // ===================================================================
            // INÍCIO DO CÓDIGO MODIFICADO PARA O CADASTRO
            // ===================================================================
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const registerErrorDiv = document.getElementById('registerErrorMessage');

                if (!name || password.length < 6) {
                    registerErrorDiv.textContent = !name ? 'Por favor, insira seu nome.' : 'A senha deve ter pelo menos 6 caracteres.';
                    registerErrorDiv.classList.remove('hidden');
                    return;
                }

                const authorizedEmailRef = doc(db, "authorizedEmails", email);
                getDoc(authorizedEmailRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        // Converte o Timestamp do Firestore para um objeto Date do JavaScript
                        const expirationDate = userData.expirationDate.toDate(); 
                        const now = new Date();

                        // Verifica se a data atual é anterior à data de expiração
                        if (now < expirationDate) {
                            // O acesso é válido, pode criar a conta
                            createUserWithEmailAndPassword(auth, email, password)
                                .then(async (userCredential) => {
                                    await updateProfile(userCredential.user, { displayName: name });
                                    await setDoc(doc(db, "atelierData", userCredential.user.uid), { name: name, hasLoggedInBefore: false }, { merge: true });
                                    alert("Cadastro realizado com sucesso!");
                                    registerErrorDiv.classList.add('hidden');
                                })
                                .catch((error) => {
                                    registerErrorDiv.textContent = error.code === 'auth/email-already-in-use' ? "Este email já está cadastrado. Tente fazer o login." : "Ocorreu um erro ao criar a sua conta.";
                                    registerErrorDiv.classList.remove('hidden');
                                });
                        } else {
                            // O acesso expirou
                            registerErrorDiv.textContent = 'O seu acesso a esta ferramenta expirou. Por favor, renove a sua assinatura para se cadastrar.';
                            registerErrorDiv.classList.remove('hidden');
                        }
                    } else {
                        // O e-mail não foi encontrado na lista de autorizados
                        registerErrorDiv.textContent = 'E-mail não autorizado. Por favor, utilize o mesmo e-mail que usou na sua compra na Hotmart.';
                        registerErrorDiv.classList.remove('hidden');
                    }
                }).catch((error) => {
                    console.error("Erro ao verificar autorização: ", error);
                    registerErrorDiv.textContent = 'Ocorreu um erro ao verificar a permissão do seu e-mail. Tente novamente mais tarde.';
                    registerErrorDiv.classList.remove('hidden');
                });
            });
            // ===================================================================
            // FIM DO CÓDIGO MODIFICADO
            // ===================================================================
            
            document.getElementById('logoutButton').addEventListener('click', () => {
                signOut(auth).catch((error) => console.error("Erro ao sair:", error));
            });
            
            async function loadUserDataAndNavigate() {
                if (!atelierDataRef) return;
                try {
                    const docSnap = await getDoc(atelierDataRef);
                    if (docSnap.exists()) {
                        atelierData = docSnap.data();
                        if (!atelierData.hasLoggedInBefore) {
                            document.getElementById('welcomeModal').classList.remove('hidden');
                        }
                    } else {
                        document.getElementById('welcomeModal').classList.remove('hidden');
                    }
                    navigate(window.location.hash || '#dashboard');
                } catch (error) {
                    console.error("Erro ao carregar dados do usuário:", error);
                }
            }

            document.getElementById('closeWelcomeModal').addEventListener('click', () => {
                document.getElementById('welcomeModal').classList.add('hidden');
                atelierData.hasLoggedInBefore = true;
                setDoc(atelierDataRef, { hasLoggedInBefore: true }, { merge: true });
                navigate('#settings');
            });

            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const callAIAssistant = async (dataPayload) => {
                const proxyUrl = '/api/gemini-proxy';
                try {
                    const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataPayload) });
                    if (!response.ok) throw new Error(`Erro: ${response.statusText}`);
                    const result = await response.json();
                    return result.text;
                } catch (error) {
                    console.error("Erro no assistente IA:", error);
                    return "Desculpe, não foi possível gerar a resposta no momento.";
                }
            };
            
            function setupCalculator() {
                const calculatorNode = document.getElementById('calculatorView');
                if (!calculatorNode) return;

                const materialsContainer = calculatorNode.querySelector('#materialsContainer');
                const tasksContainer = calculatorNode.querySelector('#tasksContainer');
                const addMaterialBtn = calculatorNode.querySelector('#addMaterial');
                const addTaskBtn = calculatorNode.querySelector('#addTask');

                const addMaterialRow = (name = '', price = '', quantity = '') => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'material-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome do Material</label> <p class="text-xs text-gray-500 mt-1">Ex: Tecido Tricoline, Linha, Zíper.</p> <input type="text" value="${name}" class="material-name piece-input w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div> <label class="text-sm font-medium text-brand-text">Preço</label> <p class="text-xs text-gray-500 mt-1">Preço do item comprado (metro, unidade).</p> <div class="relative mt-1 input-group"> <span class="input-prefix text-sm">R$</span> <input type="text" value="${price}" inputmode="decimal" placeholder="30,00" class="numeric-input piece-input material-price w-full p-2 border border-gray-200 rounded-md text-sm"> </div> </div>
                            <div> <label class="text-sm font-medium text-brand-text">Qtd. Usada</label> <p class="text-xs text-gray-500 mt-1">Fração usada (ex: 0.45 para 45cm).</p> <input type="text" value="${quantity}" inputmode="decimal" placeholder="0,45" class="numeric-input piece-input material-quantity w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        </div>`;
                    materialsContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); savePieceToLocalStorage(); });
                };

                const addTaskRow = (name = '', time = '') => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'task-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome da Tarefa</label> <p class="text-xs text-gray-500 mt-1">Ex: Cortar, Costurar, Acabamento.</p> <input type="text" value="${name}" class="task-name piece-input w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div> <label class="text-sm font-medium text-brand-text">Tempo (minutos)</label> <p class="text-xs text-gray-500 mt-1">Quanto tempo levou nesta tarefa.</p> <input type="text" value="${time}" inputmode="decimal" placeholder="40" class="numeric-input piece-input task-time w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>`;
                    tasksContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); savePieceToLocalStorage(); });
                };

                addMaterialBtn.addEventListener('click', () => addMaterialRow());
                addTaskBtn.addEventListener('click', () => addTaskRow());

                const calculateAll = () => {
                    const hourlyRate = parseFloat(atelierData.hourlyRate?.replace(',', '.')) || 0;
                    const fixedCosts = parseFloat(atelierData.fixedCosts?.replace(',', '.')) || 0;
                    const hoursWorked = parseFloat(atelierData.hoursWorked?.replace(',', '.')) || 0;
                    const fixedCostPerHour = hoursWorked > 0 ? fixedCosts / hoursWorked : 0;
                    calculatorNode.querySelector('#fixedCostPerHour').textContent = formatCurrency(fixedCostPerHour);

                    let materialsSubtotal = 0;
                    calculatorNode.querySelectorAll('.material-row').forEach(row => {
                        const price = parseFloat(row.querySelector('.material-price').value.replace(',', '.')) || 0;
                        const quantity = parseFloat(row.querySelector('.material-quantity').value.replace(',', '.')) || 0;
                        materialsSubtotal += price * quantity;
                    });
                    calculatorNode.querySelector('#materialsSubtotal').textContent = formatCurrency(materialsSubtotal);

                    let totalMinutes = 0;
                    calculatorNode.querySelectorAll('.task-row').forEach(row => {
                        totalMinutes += parseFloat(row.querySelector('.task-time').value.replace(',', '.')) || 0;
                    });
                    const totalHours = totalMinutes / 60;
                    calculatorNode.querySelector('#totalTime').textContent = `${Math.round(totalMinutes)} min`;
                    const laborCost = totalHours * hourlyRate;

                    const pieceFixedCost = totalHours * fixedCostPerHour;
                    const productionCost = materialsSubtotal + laborCost + pieceFixedCost;
                    calculatorNode.querySelector('#summaryMaterials').textContent = formatCurrency(materialsSubtotal);
                    calculatorNode.querySelector('#summaryLabor').textContent = formatCurrency(laborCost);
                    calculatorNode.querySelector('#summaryFixed').textContent = formatCurrency(pieceFixedCost);
                    calculatorNode.querySelector('#productionCost').textContent = formatCurrency(productionCost);

                    const profitMargin = parseFloat(calculatorNode.querySelector('#profitMargin').value.replace(',', '.')) || 0;
                    const fees = parseFloat(calculatorNode.querySelector('#fees').value.replace(',', '.')) || 0;
                    
                    const basePrice = productionCost * (1 + profitMargin / 100);
                    const finalPrice = fees > 0 && fees < 100 ? basePrice / (1 - fees / 100) : basePrice;
                    const feeValue = finalPrice * (fees / 100);
                    const netProfit = finalPrice - feeValue - productionCost;

                    calculatorNode.querySelector('#finalPrice').textContent = formatCurrency(finalPrice);
                    calculatorNode.querySelector('#netProfit').textContent = formatCurrency(netProfit);
                };

                function setNumericInputFilter(inputElement) {
                    inputElement.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^0-9.,]/g, '').replace(/,/g, '.');
                        const parts = value.split('.');
                        if (parts.length > 2) value = parts[0] + '.' + parts.slice(1).join('');
                        e.target.value = value;
                        calculateAll();
                    });
                }
                
                calculatorNode.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) node.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                        });
                    });
                });

                observer.observe(materialsContainer, { childList: true });
                observer.observe(tasksContainer, { childList: true });
                
                calculatorNode.querySelector('#generateDescription').addEventListener('click', async () => {
                    const pieceName = calculatorNode.querySelector('#pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(calculatorNode.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const finalPrice = calculatorNode.querySelector('#finalPrice').textContent;
                    if (materials.length === 0) { calculatorNode.querySelector('#descriptionResult').textContent = "Adicione pelo menos um material."; return; }
                    const dataPayload = { type: 'description', pieceName, materials, finalPrice };
                    calculatorNode.querySelector('#descriptionLoader').classList.remove('hidden');
                    calculatorNode.querySelector('#descriptionResult').textContent = '';
                    calculatorNode.querySelector('#descriptionResult').textContent = await callAIAssistant(dataPayload);
                    calculatorNode.querySelector('#descriptionLoader').classList.add('hidden');
                });

                calculatorNode.querySelector('#generateSuggestions').addEventListener('click', async () => {
                    const pieceName = calculatorNode.querySelector('#pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(calculatorNode.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const totalTime = calculatorNode.querySelector('#totalTime').textContent;
                    const finalPrice = calculatorNode.querySelector('#finalPrice').textContent;
                    if (materials.length === 0) { calculatorNode.querySelector('#suggestionsResult').textContent = "Adicione os detalhes da peça."; return; }
                    const dataPayload = { type: 'suggestions', pieceName, materials, totalTime, finalPrice };
                    calculatorNode.querySelector('#suggestionsLoader').classList.remove('hidden');
                    calculatorNode.querySelector('#suggestionsResult').textContent = '';
                    calculatorNode.querySelector('#suggestionsResult').textContent = await callAIAssistant(dataPayload);
                    calculatorNode.querySelector('#suggestionsLoader').classList.add('hidden');
                });
                
                const restoreBanner = calculatorNode.querySelector('#restoreBanner');

                function savePieceToLocalStorage() {
                    const materials = Array.from(calculatorNode.querySelectorAll('.material-row')).map(row => ({ name: row.querySelector('.material-name').value, price: row.querySelector('.material-price').value, quantity: row.querySelector('.material-quantity').value }));
                    const tasks = Array.from(calculatorNode.querySelectorAll('.task-row')).map(row => ({ name: row.querySelector('.task-name').value, time: row.querySelector('.task-time').value }));
                    const data = { pieceName: calculatorNode.querySelector('#pieceName').value, profitMargin: calculatorNode.querySelector('#profitMargin').value, fees: calculatorNode.querySelector('#fees').value, materials, tasks };
                    localStorage.setItem('unsavedPiece', JSON.stringify(data));
                }

                function checkAndRestorePiece() {
                    const savedData = localStorage.getItem('unsavedPiece');
                    if (savedData) {
                        restoreBanner.classList.remove('hidden');
                    } else {
                        materialsContainer.innerHTML = '';
                        tasksContainer.innerHTML = '';
                        addMaterialRow();
                        addTaskRow();
                    }
                }

                function loadPieceData(data) {
                    calculatorNode.querySelector('#pieceName').value = data.pieceName || '';
                    calculatorNode.querySelector('#profitMargin').value = data.profitMargin || '100';
                    calculatorNode.querySelector('#fees').value = data.fees || '5';
                    materialsContainer.innerHTML = '';
                    tasksContainer.innerHTML = '';
                    data.materials.forEach(m => addMaterialRow(m.name, m.price, m.quantity));
                    data.tasks.forEach(t => addTaskRow(t.name, t.time));
                    calculateAll();
                }

                calculatorNode.querySelector('#restoreYes').addEventListener('click', () => {
                    const savedData = JSON.parse(localStorage.getItem('unsavedPiece'));
                    if (savedData) {
                        loadPieceData(savedData);
                    }
                    localStorage.removeItem('unsavedPiece');
                    restoreBanner.classList.add('hidden');
                });
                
                calculatorNode.querySelector('#restoreNo').addEventListener('click', () => {
                    localStorage.removeItem('unsavedPiece');
                    restoreBanner.classList.add('hidden');
                    materialsContainer.innerHTML = '';
                    tasksContainer.innerHTML = '';
                    addMaterialRow();
                    addTaskRow();
                });

                calculatorNode.addEventListener('input', (e) => {
                    if (e.target.matches('.piece-input')) {
                        savePieceToLocalStorage();
                    }
                });
                
                calculatorNode.querySelector('#savePieceButton').addEventListener('click', async () => {
                    const pieceName = calculatorNode.querySelector('#pieceName').value;
                    if (!pieceName) {
                        alert('Por favor, dê um nome à sua peça antes de salvar.');
                        return;
                    }
                    savePieceToLocalStorage();
                    const pieceData = JSON.parse(localStorage.getItem('unsavedPiece'));
                    
                    pieceData.createdAt = new Date();
                    pieceData.finalPrice = calculatorNode.querySelector('#finalPrice').textContent;
                    
                    try {
                        await addDoc(piecesCollectionRef, pieceData);
                        alert(`Peça "${pieceName}" salva com sucesso!`);
                    } catch (error) {
                        console.error("Erro ao salvar peça:", error);
                        alert("Ocorreu um erro ao salvar sua peça.");
                    }
                });
                
                const dataToLoad = localStorage.getItem('loadPieceData');
                if (dataToLoad) {
                    loadPieceData(JSON.parse(dataToLoad));
                    localStorage.removeItem('loadPieceData');
                } else {
                    checkAndRestorePiece();
                }
            }

            const mainContent = document.getElementById('main-content');
            const templates = {
                dashboard: document.getElementById('dashboard-template'),
                calculator: document.getElementById('calculator-template'),
                'my-pieces': document.getElementById('my-pieces-template'),
                settings: document.getElementById('settings-template'),
                management: document.getElementById('coming-soon-template'),
                stock: document.getElementById('coming-soon-template'),
            };

            async function navigate(hash) {
                const targetView = hash.substring(1);
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.toggle('bg-brand-primary/20', link.hash === hash);
                });

                const template = templates[targetView];
                if (template) {
                    mainContent.innerHTML = '';
                    mainContent.appendChild(template.content.cloneNode(true));
                    
                    if (targetView === 'my-pieces') {
                        const savedPiecesContainer = document.getElementById('savedPiecesContainer');
                        const loadAndRenderSavedPieces = async () => {
                            if (!piecesCollectionRef) return;
                            savedPiecesContainer.innerHTML = '<div class="loader"></div>';
                            document.getElementById('noPiecesMessage').classList.add('hidden');
                            try {
                                const q = query(piecesCollectionRef, orderBy("createdAt", "desc"));
                                const querySnapshot = await getDocs(q);
                                savedPiecesContainer.innerHTML = '';
                                if (querySnapshot.empty) {
                                    document.getElementById('noPiecesMessage').classList.remove('hidden');
                                } else {
                                    querySnapshot.forEach(doc => {
                                        const piece = doc.data();
                                        const pieceId = doc.id;
                                        const card = document.createElement('div');
                                        card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'space-y-2');
                                        card.innerHTML = `
                                            <h3 class="font-display text-lg text-brand-text font-bold">${piece.pieceName}</h3>
                                            <p class="text-2xl font-bold text-brand-primary">${piece.finalPrice}</p>
                                            <div class="flex gap-2 pt-2">
                                                <button data-id="${pieceId}" class="load-piece-btn flex-1 bg-brand-olive text-white px-3 py-1 rounded-md text-sm font-semibold">Carregar</button>
                                                <button data-id="${pieceId}" class="delete-piece-btn flex-1 bg-red-500 text-white px-3 py-1 rounded-md text-sm font-semibold">Excluir</button>
                                            </div>`;
                                        savedPiecesContainer.appendChild(card);
                                    });
                                }
                            } catch (error) {
                                console.error("Erro ao carregar peças:", error);
                                savedPiecesContainer.innerHTML = '<p class="text-red-500">Não foi possível carregar suas peças.</p>';
                            }
                        };
                        
                        savedPiecesContainer.addEventListener('click', async (e) => {
                            const pieceId = e.target.dataset.id;
                            if (!pieceId) return;
                            if (e.target.classList.contains('delete-piece-btn')) {
                                if (confirm('Tem certeza que deseja excluir esta peça?')) {
                                    await deleteDoc(doc(db, "atelierData", currentUser.uid, "pieces", pieceId));
                                    loadAndRenderSavedPieces();
                                }
                            } else if (e.target.classList.contains('load-piece-btn')) {
                                const pieceDoc = await getDoc(doc(db, "atelierData", currentUser.uid, "pieces", pieceId));
                                if (pieceDoc.exists()) {
                                    localStorage.setItem('loadPieceData', JSON.stringify(pieceDoc.data()));
                                    navigate('#calculator');
                                }
                            }
                        });
                        loadAndRenderSavedPieces();
                    } else if (targetView === 'settings') {
                        const settingsStatus = document.getElementById('settingsStatus');
                        document.getElementById('profileName').value = currentUser.displayName || atelierData.name || '';
                        document.getElementById('profileEmail').value = currentUser.email || '';
                        document.getElementById('settingsHourlyRate').value = atelierData.hourlyRate || '';
                        document.getElementById('settingsFixedCosts').value = atelierData.fixedCosts || '';
                        document.getElementById('settingsHoursWorked').value = atelierData.hoursWorked || '';
                        
                        document.getElementById('saveProfileButton').addEventListener('click', async () => {
                            const newName = document.getElementById('profileName').value;
                            if (!newName) { alert('O nome não pode ficar em branco.'); return; }
                            await updateProfile(currentUser, { displayName: newName });
                            await setDoc(atelierDataRef, { name: newName }, { merge: true });
                            atelierData.name = newName;
                            alert('Perfil atualizado!');
                        });

                        document.getElementById('saveAtelierButton').addEventListener('click', () => {
                            atelierData.hourlyRate = document.getElementById('settingsHourlyRate').value;
                            atelierData.fixedCosts = document.getElementById('settingsFixedCosts').value;
                            atelierData.hoursWorked = document.getElementById('settingsHoursWorked').value;
                            setDoc(atelierDataRef, { ...atelierData }, { merge: true })
                                .then(() => {
                                    settingsStatus.querySelector('span').textContent = 'Salvo na nuvem!';
                                    settingsStatus.classList.remove('text-yellow-600');
                                    settingsStatus.classList.add('text-brand-olive');
                                    settingsStatus.style.opacity = '1';
                                    setTimeout(() => { settingsStatus.style.opacity = '0'; }, 2000);
                                });
                        });
                    } else if (targetView === 'calculator') {
                        setupCalculator();
                    } else if (targetView === 'dashboard') {
                        document.getElementById('welcomeMessage').textContent = `Bem-vinda, ${currentUser.displayName || 'Artesã'}!`;
                    }
                }
            }
            
            appView.addEventListener('click', (e) => {
                if (e.target.matches('.nav-link, .nav-link *')) {
                    const link = e.target.closest('.nav-link');
                    if(link.classList.contains('cursor-not-allowed')) return;
                    e.preventDefault();
                    navigate(link.hash);
                }
            });
            
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
        }

        main();
    </script>
</body>
</html>
